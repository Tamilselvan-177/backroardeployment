{% extends "base.twig" %}

{% block title %}Manage Images ‚Äî {{ product.name }}{% endblock %}

{% block content %}
<section class="container mx-auto px-4 py-8 space-y-6">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <p class="text-xs uppercase tracking-wide text-gray-500">Product</p>
            <h1 class="text-2xl font-bold text-[var(--brand-text)]">{{ product.name }}</h1>
            <p class="text-sm text-gray-500 mt-1">Drag to reorder, tap to set primary. Changes save instantly.</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <a href="{{ app_url }}/admin/products"
               class="px-4 py-2 rounded-lg border border-[var(--card-border)] hover:bg-[var(--card-bg-alt)] text-sm">
                ‚Üê Back to products
            </a>
            <a href="{{ app_url }}/product/{{ product.slug }}" target="_blank"
               class="px-4 py-2 rounded-lg bg-[var(--brand-primary)] text-white text-sm hover:bg-[var(--brand-primary-hover)]">
                Preview live
            </a>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow p-6 space-y-4 lg:col-span-2">
            <h2 class="font-semibold text-lg">Upload new images</h2>
            <p class="text-sm text-gray-500">Square images (1200px) look best. You can select multiple files.</p>
            <form action="{{ app_url }}/admin/products/{{ product.id }}/images/upload"
                  method="post" enctype="multipart/form-data" class="space-y-4">
                <input type="hidden" name="_token" value="{{ csrf_token }}">
                <div>
                    <label class="block font-semibold mb-2">Upload Images</label>
                    <input type="file" name="images[]" multiple accept="image/*"
                           class="border border-[var(--card-border)] p-2 w-full rounded-lg" required />
                    <p class="text-sm text-gray-500 mt-1">Supported: JPG, PNG, WEBP ¬∑ Max 2 MB each</p>
                </div>
                <button class="w-full bg-black text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-900 transition">
                    Upload & stay
                </button>
            </form>
        </div>

        <div class="bg-white rounded-xl shadow p-6 space-y-3">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Tips</h3>
            <ul class="text-sm text-gray-600 space-y-2">
                <li>‚Ä¢ First image becomes the product thumbnail.</li>
                <li>‚Ä¢ Use consistent backgrounds for a premium grid.</li>
                <li>‚Ä¢ Long press on mobile to drag & reorder.</li>
            </ul>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="imageGrid">
        {% for image in images %}
        <div class="bg-white rounded-xl shadow hover:shadow-lg transition p-4 draggable"
             draggable="true" data-id="{{ image.id }}">
            <div class="flex items-center justify-between text-xs uppercase text-gray-500 mb-2">
                <span>#{{ loop.index }}</span>
                {% if image.is_primary %}
                <span class="px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold text-[11px]">
                    Primary
                </span>
                {% endif %}
            </div>
            <div class="aspect-square mb-3 flex items-center justify-center bg-gray-100 rounded-lg overflow-hidden">
                <img src="{{ image.image_path }}" alt=""
                     class="object-contain max-h-72 w-full h-full" loading="lazy" decoding="async" />
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <form action="{{ app_url }}/admin/products/{{ product.id }}/images/{{ image.id }}/primary"
                      method="post" class="flex-1">
                    <input type="hidden" name="_token" value="{{ csrf_token }}">
                    <button class="w-full px-3 py-2 rounded-lg text-sm font-semibold
                                   {{ image.is_primary ? 'bg-green-600 text-white' : 'bg-gray-200 hover:bg-gray-300' }}">
                        {{ image.is_primary ? 'Primary image' : 'Set as primary' }}
                    </button>
                </form>
                <form action="{{ app_url }}/admin/images/{{ image.id }}/delete"
                      method="post" onsubmit="return confirm('Delete this image?')" class="flex-1">
                    <input type="hidden" name="_token" value="{{ csrf_token }}">
                    <button class="w-full px-3 py-2 rounded-lg bg-red-50 text-red-600 text-sm font-semibold hover:bg-red-100">
                        Delete
                    </button>
                </form>
            </div>
            <p class="text-xs text-gray-400 mt-3 truncate">{{ image.image_path }}</p>
        </div>
        {% else %}
        <div class="col-span-3 text-center text-gray-600 bg-white rounded-xl shadow p-10">
            <div class="text-6xl mb-3">üì∑</div>
            <p class="font-semibold text-lg mb-2">No images yet</p>
            <p class="text-sm text-gray-500">Upload a few shots to bring this product page to life.</p>
        </div>
        {% endfor %}
    </div>

    {% if images|length > 1 %}
    <form action="{{ app_url }}/admin/products/{{ product.id }}/images/reorder"
          method="post"
          class="sticky bottom-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-white/90 backdrop-blur rounded-xl p-4 shadow-lg border border-[var(--card-border)]"
          id="reorderForm">
        <input type="hidden" name="_token" value="{{ csrf_token }}">
        <input type="hidden" name="image_ids" id="imageIds" />
        <p class="text-sm text-gray-500 m-0">
            Drag images to reorder, then save to lock positions.
        </p>
        <button type="submit"
                class="bg-black text-white px-6 py-2 rounded-lg font-semibold w-full md:w-auto"
                id="saveOrderBtn">
            Save display order
        </button>
    </form>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
const grid = document.getElementById('imageGrid');
let dragEl = null;

if (grid) {
    grid.addEventListener('dragstart', (e) => {
        dragEl = e.target.closest('.draggable');
    });

    grid.addEventListener('dragover', (e) => {
        e.preventDefault();
        const target = e.target.closest('.draggable');
        if (!dragEl || !target || dragEl === target) return;
        const rect = target.getBoundingClientRect();
        const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
        grid.insertBefore(dragEl, next ? target.nextSibling : target);
    });
}

const reorderForm = document.getElementById('reorderForm');
if (reorderForm) {
    reorderForm.addEventListener('submit', function () {
        const ids = [...document.querySelectorAll('#imageGrid .draggable')].map(el => el.dataset.id);
        document.getElementById('imageIds').value = ids.join(',');
    });
}

// Auto-scroll to gallery when success flash is visible (after upload), if you use flashes
const flashSuccess = document.querySelector('[class*="bg-green-100"]');
if (flashSuccess && grid) {
    grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
{% endblock %}
