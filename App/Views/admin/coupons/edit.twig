{% extends 'base.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<section class="py-10 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 max-w-3xl">

        <!-- Header -->
        <div class="mb-8">
            <a href="{{ app_url }}/admin/coupons"
               class="text-blue-600 hover:text-blue-800 font-semibold text-sm mb-4 inline-block">
                ← Back to Coupons
            </a>
            <h1 class="text-3xl font-bold text-gray-900">Edit Coupon: {{ coupon.code }}</h1>
        </div>

        <!-- Form -->
        <form method="POST" action="{{ app_url }}/admin/coupons/{{ coupon.id }}/update"
              class="bg-white rounded-lg shadow p-8">

            <input type="hidden" name="_token" value="{{ csrf_token }}">

            {# dtype comes as 'PERCENT' or 'FIXED' from controller, or from old.discount_type #}
            {% set dtype = old.discount_type|default(coupon.discount_type) %}

            <!-- Coupon Code -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    Coupon Code *
                </label>
                <input type="text"
                       name="code"
                       value="{{ old.code|default(coupon.code) }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 uppercase"
                       required>
                {% if errors.code %}
                    <p class="text-red-600 text-sm mt-1">{{ errors.code }}</p>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    Description
                </label>
                <textarea name="description" rows="2"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">{{ old.description|default(coupon.description) }}</textarea>
            </div>

            <!-- Discount Type & Value -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

                <!-- Discount Type (Locked) -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        Discount Type *
                    </label>

                    <select id="discountType"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100"
                            disabled>
                        <option value="PERCENT" {% if dtype == 'PERCENT' %}selected{% endif %}>Percentage (%)</option>
                        <option value="FIXED" {% if dtype == 'FIXED' %}selected{% endif %}>Fixed Amount (₹)</option>
                    </select>

                    <!-- Keep actual value in hidden field -->
                    <input type="hidden" name="discount_type" value="{{ dtype }}">
                </div>

                <!-- Discount Value -->
                <div>
                    <label id="discountValueLabel" class="block text-sm font-bold text-gray-700 mb-2">
                        {{ dtype == 'FIXED' ? 'Amount (₹) *' : 'Percentage (%) *' }}
                    </label>

                    <input type="number"
                           id="discountValue"
                           name="discount_value"
                           value="{{ old.discount_value|default(coupon.discount_value) }}"
                           step="{{ dtype == 'FIXED' ? '0.01' : '1' }}"
                           min="1"
                           {% if dtype == 'PERCENT' %}max="100"{% endif %}
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           required>

                    {% if errors.discount_value %}
                        <p class="text-red-600 text-sm mt-1">{{ errors.discount_value }}</p>
                    {% endif %}
                </div>

            </div>

            <!-- Minimum Purchase (for both types) -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">Minimum Purchase (₹)</label>
                <input type="number"
                       name="min_purchase"
                       value="{{ old.min_purchase|default(coupon.min_purchase) }}"
                       step="0.01"
                       min="0"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500 mt-1">0 = no minimum</p>
            </div>

            <!-- Maximum Discount (percentage only) -->
            {% if dtype == 'PERCENT' %}
            <div class="mb-6" id="maxDiscountField">
                <label class="block text-sm font-bold text-gray-700 mb-2">Maximum Discount (₹)</label>
                <input type="number"
                       name="max_discount"
                       value="{{ old.max_discount|default(coupon.max_discount) }}"
                       step="0.01"
                       min="0"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500 mt-1">Only for percentage discounts</p>
            </div>
            {% endif %}

            <!-- Usage Limits -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Total Usage Limit</label>
                    <input type="number"
                           name="usage_limit"
value="{{ old.usage_limit|default(coupon.usage_limit_global) }}"
                           min="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">0 = Unlimited</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Per User Limit</label>
                    <input type="number"
                           name="per_user_limit"
value="{{ old.per_user_limit|default(coupon.usage_limit_per_user) }}"
                           min="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">0 = Unlimited</p>
                </div>

            </div>

            <!-- Valid Period -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Valid From *</label>

                    <input type="datetime-local"
                           name="valid_from"
                           value="{{ old.valid_from|default(coupon.valid_from_formatted) }}"
                           class="w-full px-4 py-2 border rounded-lg"
                           required>
                    {% if errors.valid_from %}
                        <p class="text-red-600 text-sm mt-1">{{ errors.valid_from }}</p>
                    {% endif %}
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Valid To *</label>

                    <input type="datetime-local"
                           name="valid_to"
                           value="{{ old.valid_to|default(coupon.valid_to_formatted) }}"
                           class="w-full px-4 py-2 border rounded-lg"
                           required>
                    {% if errors.valid_to %}
                        <p class="text-red-600 text-sm mt-1">{{ errors.valid_to }}</p>
                    {% endif %}
                </div>

            </div>

            <!-- Is Active -->
            <div class="mb-8">
                <label class="flex items-center gap-2">
                    <input type="checkbox"
                           name="is_active"
                           {% if (old.is_active is defined and old.is_active) or (old.is_active is not defined and coupon.is_active) %}
                           checked
                           {% endif %}
                           class="w-4 h-4">
                    <span class="text-sm font-semibold text-gray-700">Coupon is active</span>
                </label>
            </div>

            <!-- Actions -->
            <div class="flex gap-4">
                <button type="submit"
                        class="px-8 py-3 bg-black text-white rounded-lg font-bold hover:bg-gray-800">
                    Update Coupon
                </button>

                <a href="{{ app_url }}/admin/coupons"
                   class="px-8 py-3 border rounded-lg font-bold hover:bg-gray-50">
                    Cancel
                </a>
            </div>

        </form>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // dtype is 'PERCENT' or 'FIXED'
    const type = "{{ dtype }}";
    const maxField = document.getElementById('maxDiscountField');
    const label = document.getElementById('discountValueLabel');
    const input = document.getElementById('discountValue');

    if (type === 'FIXED') {
        if (maxField) maxField.style.display = 'none';
        if (input) {
            input.step = '0.01';
            input.removeAttribute('max');
        }
        if (label) label.textContent = 'Amount (₹) *';
    }
});
</script>

{% endblock %}
