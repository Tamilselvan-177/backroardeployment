{% extends "base.twig" %}

{% block title %}Orders — Admin{% endblock %}

{% block styles %}
<style>
    @keyframes adminFadeUp {
        from { opacity:0; transform: translateY(20px); }
        to   { opacity:1; transform: translateY(0); }
    }
    .admin-shell {
        background: radial-gradient(circle at top, #f9fafb 0%, #e5e7eb 40%, #f3f4f6 100%);
        min-height: calc(100vh - 64px);
    }
    .admin-panel {
        animation: adminFadeUp .4s ease-out;
    }
    .admin-card {
        background:#ffffff;
        border-radius:1.1rem;
        box-shadow:0 18px 40px rgba(15,23,42,0.12),0 0 0 1px rgba(148,163,184,0.25);
        border:1px solid rgba(148,163,184,0.5);
    }
    .admin-pill {
        font-size:.7rem;
        text-transform:uppercase;
        letter-spacing:.18em;
        color:#6b7280;
    }
    .status-pill{
        font-size:11px;
        padding:0.2rem 0.6rem;
        border-radius:999px;
        font-weight:600;
        display:inline-block;
    }
</style>
{% endblock %}

{% block content %}
<section class="admin-shell py-8">
    <div class="container mx-auto px-4 admin-panel">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <a href="{{ app_url }}/admin"
                   class="px-3 py-1 rounded-full border border-[var(--card-border)] text-[11px] font-semibold text-gray-600 hover:bg-[var(--card-bg-alt)]">
                    ← Dashboard
                </a>
                <div>
                    <p class="admin-pill mb-1">Admin / Orders</p>
                    <h1 class="text-2xl md:text-3xl font-black tracking-[0.14em] uppercase text-[var(--brand-heading)]">
                        Orders
                    </h1>
                </div>
            </div>
        </div>

        {% if session.flash.success %}
        <div class="mb-4 px-4 py-3 rounded-lg bg-green-50 border border-green-200 text-sm text-green-700">
            {{ session.flash.success }}
        </div>
        {% endif %}
        {% if session.flash.error %}
        <div class="mb-4 px-4 py-3 rounded-lg bg-red-50 border border-red-200 text-sm text-red-700">
            {{ session.flash.error }}
        </div>
        {% endif %}
        <!-- Filters -->
<form method="get" class="mb-6 bg-white p-4 rounded-lg border border-gray-300 grid grid-cols-1 md:grid-cols-5 gap-4">

    <!-- Order Status -->
    <select name="status" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
        <option value="">All Status</option>
        {% for s in ['Pending','Confirmed','Processing','Shipped','Delivered','Cancelled'] %}
            <option value="{{ s }}" {% if s == app.request.get('status') %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
    </select>

    <!-- Payment Status -->
    <select name="payment" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
        <option value="">All Payment</option>
        {% for p in ['Paid','Failed','Pending'] %}
            <option value="{{ p }}" {% if p == app.request.get('payment') %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
    </select>

    <!-- From Date -->
    <input type="date" name="from" value="{{ app.request.get('from') }}" 
           class="border border-gray-300 rounded-lg px-3 py-2 text-sm">

    <!-- To Date -->
    <input type="date" name="to" value="{{ app.request.get('to') }}" 
           class="border border-gray-300 rounded-lg px-3 py-2 text-sm">

    <!-- Search -->
<input type="text" name="search" value="{{ app.request.get('search') }}"
       placeholder="Order number / User ID / Email"
       class="border border-gray-300 rounded-lg px-3 py-2 text-sm">

    <div class="md:col-span-5 flex gap-2">
        <button class="px-4 py-2 bg-[var(--brand-navbar)] text-white rounded-lg text-sm hover:bg-black">
            Apply Filters
        </button>

        <a href="{{ app_url }}/admin/orders"
           class="px-4 py-2 bg-gray-300 rounded-lg text-sm hover:bg-gray-400">
           Reset
        </a>
    </div>
</form>


        <!-- Table -->
        <div class="admin-card overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="bg-gray-50 text-left text-xs uppercase tracking-wide text-gray-500">
                        <th class="p-3">#</th>
                        <th class="p-3">Order Number</th>
                        <th class="p-3">User</th>
                        <th class="p-3">Email</th>

                        <th class="p-3">Total</th>
                        <th class="p-3">Payment</th>
                        <th class="p-3">Status</th>
                        <th class="p-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for o in orders %}
                    <tr class="border-t border-[var(--card-border)] bg-white hover:bg-gray-50">
                        <td class="p-3 align-top text-xs">{{ o.id }}</td>
                        <td class="p-3 align-top">
                            <div class="font-semibold text-[var(--brand-text)] text-sm">
                                {{ o.order_number }}
                            </div>
                            <div class="text-[11px] text-gray-500">
                                {{ o.created_at|date('d M Y H:i') }}
                            </div>
                            {% set summary = order_items_summary[o.id]|default(null) %}
                            {% if summary %}
                            <div class="text-[11px] text-gray-500">
                                Items: {{ summary.distinct_count }} • Qty: {{ summary.total_qty }}
                                {% if summary.preview_str %}
                                    — {{ summary.preview_str }}{% if summary.distinct_count > 3 %} +{{ summary.distinct_count - 3 }} more{% endif %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="p-3 align-top text-xs text-gray-700">
                            {{ o.user_id }}
                        </td>
                        <td class="p-3 align-top text-xs text-gray-700">
    {{ o.user_email ?? '—' }}
</td>

                        <td class="p-3 align-top text-xs">
                            ₹{{ o.total_amount }}
                        </td>
                        <td class="p-3 align-top text-xs">
                            {% if o.payment_status == 'Paid' %}
                                <span class="status-pill bg-green-100 text-green-700">Paid</span>
                            {% elseif o.payment_status == 'Failed' %}
                                <span class="status-pill bg-red-100 text-red-700">Failed</span>
                            {% else %}
                                <span class="status-pill bg-yellow-100 text-yellow-700">{{ o.payment_status }}</span>
                            {% endif %}
                        </td>
                        <td class="p-3 align-top text-xs">
                            {% set s = o.order_status %}
                            {% if s == 'Pending' %}
                                <span class="status-pill bg-gray-100 text-gray-700">Pending</span>
                            {% elseif s == 'Confirmed' %}
                                <span class="status-pill bg-blue-100 text-blue-700">Confirmed</span>
                            {% elseif s == 'Processing' %}
                                <span class="status-pill bg-indigo-100 text-indigo-700">Processing</span>
                            {% elseif s == 'Shipped' %}
                                <span class="status-pill bg-sky-100 text-sky-700">Shipped</span>
                            {% elseif s == 'Delivered' %}
                                <span class="status-pill bg-green-100 text-green-700">Delivered</span>
                            {% else %}
                                <span class="status-pill bg-red-100 text-red-700">Cancelled</span>
                            {% endif %}
                        </td>
                        <td class="p-3 align-top">
                            <form action="{{ app_url }}/admin/orders/{{ o.id }}/status"
                                  method="post"
                                  class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 text-xs">
                                <input type="hidden" name="_token" value="{{ csrf_token }}">
                                <select name="order_status"
                                        class="border border-[var(--card-border)] rounded-lg px-2 py-1 text-xs">
                                    {% for s in ['Pending','Confirmed','Processing','Shipped','Delivered','Cancelled'] %}
                                    <option value="{{ s }}" {% if s == o.order_status %}selected{% endif %}>{{ s }}</option>
                                    {% endfor %}
                                </select>
                                <button class="px-3 py-1 rounded-full bg-[var(--brand-navbar)] text-white text-[11px] font-semibold hover:bg-black">
                                    Update
                                </button>
                            </form>
                        </td>
                        <td class="p-3 align-top">
    <a href="{{ app_url }}/admin/orders/{{ o.id }}/show" 
       style="color: #2196F3; text-decoration: none; font-weight: 500;">
        {{ o.order_number }}
    </a>
    <div class="text-[11px] text-gray-500">
        {{ o.created_at|date('d M Y H:i') }}
    </div>
</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="p-4 text-center text-gray-600 text-sm">No orders</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        {% if pagination.total_pages > 1 %}
        <div class="mt-6 flex justify-center space-x-2 text-xs">
            {% for i in 1..pagination.total_pages %}
                <a href="{{ app_url }}/admin/orders?page={{ i }}"
                   class="px-3 py-1 rounded-full {{ i == pagination.current_page ? 'bg-[var(--brand-navbar)] text-white' : 'bg-gray-200 hover:bg-gray-300' }}">
                    {{ i }}
                </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}
